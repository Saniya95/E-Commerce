<%- include('../partials/header', { title: "Forgot Password" }) %>

<div class="mt-10 p-6 max-w-md mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-md">
  <h2 class="text-2xl font-bold mb-4 text-center">Reset Password via OTP</h2>

  <form id="otp-form" class="space-y-4">
    <input id="phone" type="text" placeholder="Enter Phone (+91...)" class="w-full px-4 py-2 border rounded-md dark:bg-gray-700 text-black">
    <div id="recaptcha-container"></div>
    <button type="button" onclick="sendOTP()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Send OTP</button>

    <input id="otp" type="text" placeholder="Enter OTP" class="w-full px-4 py-2 border rounded-md dark:bg-gray-700 text-black">
    <input id="newPassword" type="password" placeholder="New Password" class="w-full px-4 py-2 border rounded-md dark:bg-gray-700 text-black">

    <button type="button" onclick="verifyOTPAndReset()" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">Reset Password</button>
  </form>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDtdqEQ-6i36jN4wjskD9MGmKMNCaZa6Ms",
    authDomain: "e--commerce-2df01.firebaseapp.com",
    projectId: "e--commerce-2df01",
    storageBucket: "e--commerce-2df01.appspot.com",
    messagingSenderId: "52883930355",
    appId: "1:52883930355:web:25f218ba07bccc7eadcb86",
    measurementId: "G-078JPRSNZ3"
  };
  firebase.initializeApp(firebaseConfig);
  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
    size: 'normal', callback: () => {}
  });

  function sendOTP() {
    const phoneNumber = document.getElementById('phone').value;
    const appVerifier = window.recaptchaVerifier;

    firebase.auth().signInWithPhoneNumber(phoneNumber, appVerifier)
      .then(confirmationResult => {
        window.confirmationResult = confirmationResult;
        alert("OTP sent");
      }).catch(error => alert(error.message));
  }

  function verifyOTPAndReset() {
  const otp = document.getElementById('otp').value;
  const newPassword = document.getElementById('newPassword').value;

  confirmationResult.confirm(otp).then(result => {
    result.user.getIdToken().then(idToken => {
      fetch("/users/reset-password", { // ✅ Ensure correct route
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          firebaseToken: idToken,
          newPassword: newPassword
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("✅ Password reset successful!");
          // ✅ Redirect to homepage after success
          window.location.href = "/";
        } else {
          alert("❌ Reset failed");
        }
      });
    });
  }).catch(() => alert("Invalid OTP"));
}

</script>

<%- include('../partials/footer') %>

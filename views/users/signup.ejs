<%- include('../partials/header', { title: "Signup" }) %>
<main class="min-h-screen flex justify-center items-center bg-gray-100 dark:bg-gray-900">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md w-full max-w-2xl p-8">
    <h2 class="text-2xl font-bold text-center mb-6 text-black dark:text-white">Create Account</h2>

    <!-- ‚úÖ STEP 1: PHONE + OTP SECTION -->
    <div id="step1">
      <input id="phone" type="text" placeholder="Enter Phone (+91...)" class="w-full px-4 py-2 mb-2 border rounded-md text-black">
      <div id="recaptcha-container"></div>
      <button type="button" onclick="sendOTP()" class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600">Send OTP</button>

      <div id="otpSection" class="hidden mt-4">
        <input id="otp" type="text" placeholder="Enter OTP" class="w-full px-4 py-2 border rounded-md text-black">
        <button type="button" onclick="verifyOTP()" class="w-full bg-purple-500 text-white py-2 rounded hover:bg-purple-600 mt-2">Verify OTP</button>
      </div>
    </div>

    <!-- ‚úÖ STEP 2: FORM AFTER VERIFICATION -->
    <form id="step2" action="/users/signup" method="POST" class="space-y-4 hidden mt-6">
      <input name="fullname" type="text" placeholder="Full Name" class="w-full px-4 py-2 border rounded-md text-black">
      <input name="email" type="email" placeholder="Email" class="w-full px-4 py-2 border rounded-md text-black">
      <input name="contact" type="text" readonly class="w-full px-4 py-2 border rounded-md text-black">
      <input name="password" type="password" placeholder="Password" class="w-full px-4 py-2 border rounded-md text-black">
      <input name="confirmPassword" type="password" placeholder="Confirm Password" class="w-full px-4 py-2 border rounded-md text-black">

      <input name="location" id="location" type="text" placeholder="Fetching Location..." class="w-full px-4 py-2 border rounded-md text-black" readonly>
      <button type="button" onclick="getLocation()" class="text-sm text-blue-500 underline">üìç Refresh Location</button>

      <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Signup</button>
    </form>
  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDtdqEQ-6i36jN4wjskD9MGmKMNCaZa6Ms",
    authDomain: "e--commerce-2df01.firebaseapp.com",
    projectId: "e--commerce-2df01",
    storageBucket: "e--commerce-2df01.appspot.com",
    messagingSenderId: "52883930355",
    appId: "1:52883930355:web:25f218ba07bccc7eadcb86",
    measurementId: "G-078JPRSNZ3"
  };
  firebase.initializeApp(firebaseConfig);

  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
    size: 'normal',
    callback: () => {}
  });

  function sendOTP() {
    const phone = document.getElementById("phone").value;
    const appVerifier = window.recaptchaVerifier;
    firebase.auth().signInWithPhoneNumber(phone, appVerifier)
      .then(result => {
        window.confirmationResult = result;
        document.getElementById("otpSection").classList.remove("hidden");
        alert("OTP sent!");
      })
      .catch(error => alert(error.message));
  }

  function verifyOTP() {
    const otp = document.getElementById("otp").value;
    confirmationResult.confirm(otp).then(result => {
      document.getElementById("step1").classList.add("hidden");
      document.getElementById("step2").classList.remove("hidden");
      document.querySelector("input[name='contact']").value = document.getElementById("phone").value;
      getLocation();
    }).catch(() => alert("Invalid OTP"));
  }

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async function(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
          const data = await res.json();
          document.getElementById("location").value = data.display_name;
        } catch {
          document.getElementById("location").value = "Could not fetch address.";
        }
      });
    } else {
      alert("Geolocation not supported");
    }
  }
</script>
<%- include('../partials/footer') %>

